import React, { useState, useEffect } from 'react';
import { Calendar, Users, Clock, BarChart3, Plus, Trash2, Edit, LogOut, User, Shield } from 'lucide-react';
import './App.css';

const API_URL = process.env.REACT_APP_BACKEND_URL;

function App() {
  const [user, setUser] = useState(null);
  const [currentView, setCurrentView] = useState('login');
  const [selectedMonth, setSelectedMonth] = useState(new Date().getMonth() + 1);
  const [selectedYear, setSelectedYear] = useState(new Date().getFullYear());
  const [schedule, setSchedule] = useState(null);
  const [users, setUsers] = useState([]);
  const [myShifts, setMyShifts] = useState({ shifts: [], stats: {} });
  const [loading, setLoading] = useState(false);

  const months = [
    '–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å',
    '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'
  ];

  const weekDays = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];

  useEffect(() => {
    const token = localStorage.getItem('token');
    const userData = localStorage.getItem('user');
    if (token && userData) {
      setUser(JSON.parse(userData));
      setCurrentView(JSON.parse(userData).role === 'manager' ? 'schedule' : 'my-schedule');
    }
  }, []);

  useEffect(() => {
    if (user) {
      fetchSchedule();
      if (user.role === 'manager') {
        fetchUsers();
      } else {
        fetchMyShifts();
      }
    }
  }, [user, selectedMonth, selectedYear]);

  const apiCall = async (endpoint, options = {}) => {
    const token = localStorage.getItem('token');
    const response = await fetch(`${API_URL}/api${endpoint}`, {
      headers: {
        'Authorization': token ? `Bearer ${token}` : '',
        'Content-Type': 'application/json',
        ...options.headers
      },
      ...options
    });

    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.detail || 'Request failed');
    }

    return response.json();
  };

  const login = async (email, password) => {
    try {
      setLoading(true);
      const response = await apiCall('/auth/login', {
        method: 'POST',
        body: JSON.stringify({ email, password })
      });

      localStorage.setItem('token', response.access_token);
      localStorage.setItem('user', JSON.stringify(response.user));
      setUser(response.user);
      setCurrentView(response.user.role === 'manager' ? 'schedule' : 'my-schedule');
    } catch (error) {
      alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + error.message);
    } finally {
      setLoading(false);
    }
  };

  const logout = () => {
    localStorage.removeItem('token');
    localStorage.removeItem('user');
    setUser(null);
    setCurrentView('login');
  };

  const fetchSchedule = async () => {
    try {
      const response = await apiCall(`/schedules/${selectedYear}/${selectedMonth}`);
      setSchedule(response.schedule);
    } catch (error) {
      console.error('Error fetching schedule:', error);
    }
  };

  const fetchUsers = async () => {
    try {
      const response = await apiCall('/users');
      setUsers(response.filter(u => u.role === 'employee'));
    } catch (error) {
      console.error('Error fetching users:', error);
    }
  };

  const fetchMyShifts = async () => {
    try {
      const response = await apiCall(`/my-shifts/${selectedYear}/${selectedMonth}`);
      setMyShifts(response);
    } catch (error) {
      console.error('Error fetching my shifts:', error);
    }
  };

  const createUser = async (userData) => {
    try {
      await apiCall('/auth/register', {
        method: 'POST',
        body: JSON.stringify(userData)
      });
      fetchUsers();
      alert('–°–æ—Ç—Ä—É–¥–Ω–∏–∫ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω');
    } catch (error) {
      alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è: ' + error.message);
    }
  };

  const deleteUser = async (userId) => {
    try {
      await apiCall(`/users/${userId}`, { method: 'DELETE' });
      fetchUsers();
      alert('–°–æ—Ç—Ä—É–¥–Ω–∏–∫ —É–¥–∞–ª–µ–Ω');
    } catch (error) {
      alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + error.message);
    }
  };

  const saveSchedule = async (shifts) => {
    try {
      setLoading(true);
      await apiCall('/schedules', {
        method: 'POST',
        body: JSON.stringify({
          month: selectedMonth,
          year: selectedYear,
          shifts
        })
      });
      fetchSchedule();
      alert('–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
    } catch (error) {
      alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message);
    } finally {
      setLoading(false);
    }
  };

  const getDaysInMonth = (month, year) => {
    return new Date(year, month, 0).getDate();
  };

  const getFirstDayOfMonth = (month, year) => {
    const firstDay = new Date(year, month - 1, 1).getDay();
    return firstDay === 0 ? 6 : firstDay - 1; // Convert to Monday = 0
  };

  const renderCalendarGrid = () => {
    const daysInMonth = getDaysInMonth(selectedMonth, selectedYear);
    const firstDay = getFirstDayOfMonth(selectedMonth, selectedYear);
    const days = [];

    // Empty cells for days before the first day of the month
    for (let i = 0; i < firstDay; i++) {
      days.push(<div key={`empty-${i}`} className="calendar-day empty"></div>);
    }

    // Days of the month
    for (let day = 1; day <= daysInMonth; day++) {
      const dateStr = `${selectedYear}-${selectedMonth.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
      const dayShift = schedule?.shifts?.find(s => s.date === dateStr);
      
      days.push(
        <div key={day} className="calendar-day">
          <div className="day-header">
            <span className="day-number">{day}</span>
            <span className="day-week">{weekDays[(firstDay + day - 1) % 7]}</span>
          </div>
          {dayShift && (
            <div className="shift-info">
              <div className={`shift-type shift-${dayShift.type}`}>
                {dayShift.type === 'day' ? '‚òÄÔ∏è –î–µ–Ω—å' : dayShift.type === 'night' ? 'üåô –ù–æ—á—å' : '‚è∞ ' + dayShift.hours + '—á'}
              </div>
              <div className="shift-employees">
                {dayShift.assignments?.map((assignment, idx) => (
                  <div key={idx} className="employee-name">
                    {assignment.employee_name}
                  </div>
                ))}
              </div>
            </div>
          )}
          {user?.role === 'manager' && (
            <button 
              className="edit-day-btn"
              onClick={() => editDayShift(dateStr)}
            >
              <Edit size={12} />
            </button>
          )}
        </div>
      );
    }

    return days;
  };

  const editDayShift = (dateStr) => {
    const dayShift = schedule?.shifts?.find(s => s.date === dateStr) || {
      date: dateStr,
      type: 'day',
      assignments: [],
      hours: null
    };

    const newType = prompt('–¢–∏–ø —Å–º–µ–Ω—ã (day/night/custom):', dayShift.type);
    if (!newType) return;

    let hours = null;
    if (newType === 'custom') {
      hours = parseInt(prompt('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞—Å–æ–≤:', dayShift.hours || 8));
      if (!hours) return;
    }

    const employeeIds = prompt(
      'ID —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é:\n' + users.map(u => `${u.id}: ${u.name}`).join('\n'),
      dayShift.assignments?.map(a => a.employee_id).join(',') || ''
    );

    if (employeeIds === null) return;

    const assignments = employeeIds
      .split(',')
      .map(id => id.trim())
      .filter(id => id)
      .map(id => {
        const user = users.find(u => u.id === id);
        return user ? { employee_id: id, employee_name: user.name } : null;
      })
      .filter(Boolean);

    const updatedShifts = [...(schedule?.shifts || [])];
    const existingIndex = updatedShifts.findIndex(s => s.date === dateStr);

    const newShift = {
      date: dateStr,
      type: newType,
      assignments,
      hours: newType === 'custom' ? hours : null
    };

    if (existingIndex >= 0) {
      if (assignments.length === 0) {
        updatedShifts.splice(existingIndex, 1);
      } else {
        updatedShifts[existingIndex] = newShift;
      }
    } else if (assignments.length > 0) {
      updatedShifts.push(newShift);
    }

    saveSchedule(updatedShifts);
  };

  if (!user) {
    return <LoginForm onLogin={login} loading={loading} />;
  }

  return (
    <div className="app">
      <header className="app-header">
        <div className="header-content">
          <div className="logo">
            <Calendar className="logo-icon" />
            <span>–ì—Ä–∞—Ñ–∏–∫ –°–º–µ–Ω</span>
          </div>
          <nav className="nav-menu">
            {user.role === 'manager' ? (
              <>
                <button 
                  className={currentView === 'schedule' ? 'nav-btn active' : 'nav-btn'}
                  onClick={() => setCurrentView('schedule')}
                >
                  <Calendar size={18} />
                  –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ
                </button>
                <button 
                  className={currentView === 'users' ? 'nav-btn active' : 'nav-btn'}
                  onClick={() => setCurrentView('users')}
                >
                  <Users size={18} />
                  –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏
                </button>
              </>
            ) : (
              <>
                <button 
                  className={currentView === 'my-schedule' ? 'nav-btn active' : 'nav-btn'}
                  onClick={() => setCurrentView('my-schedule')}
                >
                  <Calendar size={18} />
                  –ú–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
                </button>
                <button 
                  className={currentView === 'stats' ? 'nav-btn active' : 'nav-btn'}
                  onClick={() => setCurrentView('stats')}
                >
                  <BarChart3 size={18} />
                  –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                </button>
              </>
            )}
          </nav>
          <div className="user-menu">
            <div className="user-info">
              {user.role === 'manager' ? <Shield size={16} /> : <User size={16} />}
              <span>{user.name}</span>
            </div>
            <button className="logout-btn" onClick={logout}>
              <LogOut size={16} />
            </button>
          </div>
        </div>
      </header>

      <main className="main-content">
        {(currentView === 'schedule' || currentView === 'my-schedule') && (
          <div className="schedule-container">
            <div className="schedule-header">
              <h2>
                {currentView === 'schedule' ? '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º' : '–ú–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ'}
              </h2>
              <div className="month-selector">
                <select 
                  value={selectedMonth} 
                  onChange={(e) => setSelectedMonth(parseInt(e.target.value))}
                >
                  {months.map((month, idx) => (
                    <option key={idx} value={idx + 1}>{month}</option>
                  ))}
                </select>
                <select 
                  value={selectedYear} 
                  onChange={(e) => setSelectedYear(parseInt(e.target.value))}
                >
                  {[2024, 2025, 2026].map(year => (
                    <option key={year} value={year}>{year}</option>
                  ))}
                </select>
              </div>
            </div>

            <div className="calendar-grid">
              {renderCalendarGrid()}
            </div>

            {loading && <div className="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>}
          </div>
        )}

        {currentView === 'users' && (
          <UsersManagement 
            users={users} 
            onCreateUser={createUser} 
            onDeleteUser={deleteUser} 
          />
        )}

        {currentView === 'stats' && (
          <StatsView stats={myShifts.stats} shifts={myShifts.shifts} />
        )}
      </main>
    </div>
  );
}

const LoginForm = ({ onLogin, loading }) => {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');

  const handleSubmit = (e) => {
    e.preventDefault();
    onLogin(email, password);
  };

  return (
    <div className="login-container">
      <div className="login-card">
        <div className="login-header">
          <Calendar className="login-icon" />
          <h1>–ì—Ä–∞—Ñ–∏–∫ –°–º–µ–Ω</h1>
          <p>–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º</p>
        </div>
        
        <form onSubmit={handleSubmit} className="login-form">
          <div className="form-group">
            <label>Email</label>
            <input
              type="email"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              placeholder="manager@company.com"
              required
            />
          </div>
          
          <div className="form-group">
            <label>–ü–∞—Ä–æ–ª—å</label>
            <input
              type="password"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
              required
            />
          </div>
          
          <button type="submit" className="login-btn" disabled={loading}>
            {loading ? '–í—Ö–æ–¥...' : '–í–æ–π—Ç–∏'}
          </button>
        </form>

        <div className="login-demo">
          <p><strong>–î–µ–º–æ –¥–∞–Ω–Ω—ã–µ:</strong></p>
          <p>–ú–µ–Ω–µ–¥–∂–µ—Ä: manager@company.com / manager123</p>
        </div>
      </div>
    </div>
  );
};

const UsersManagement = ({ users, onCreateUser, onDeleteUser }) => {
  const [showForm, setShowForm] = useState(false);
  const [formData, setFormData] = useState({ name: '', email: '', password: '' });

  const handleSubmit = (e) => {
    e.preventDefault();
    onCreateUser({ ...formData, role: 'employee' });
    setFormData({ name: '', email: '', password: '' });
    setShowForm(false);
  };

  return (
    <div className="users-container">
      <div className="users-header">
        <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º–∏</h2>
        <button className="add-user-btn" onClick={() => setShowForm(true)}>
          <Plus size={18} />
          –î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
        </button>
      </div>

      {showForm && (
        <div className="user-form-overlay">
          <div className="user-form">
            <h3>–ù–æ–≤—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫</h3>
            <form onSubmit={handleSubmit}>
              <input
                type="text"
                placeholder="–ò–º—è"
                value={formData.name}
                onChange={(e) => setFormData({...formData, name: e.target.value})}
                required
              />
              <input
                type="email"
                placeholder="Email"
                value={formData.email}
                onChange={(e) => setFormData({...formData, email: e.target.value})}
                required
              />
              <input
                type="password"
                placeholder="–ü–∞—Ä–æ–ª—å"
                value={formData.password}
                onChange={(e) => setFormData({...formData, password: e.target.value})}
                required
              />
              <div className="form-actions">
                <button type="button" onClick={() => setShowForm(false)}>–û—Ç–º–µ–Ω–∞</button>
                <button type="submit">–°–æ–∑–¥–∞—Ç—å</button>
              </div>
            </form>
          </div>
        </div>
      )}

      <div className="users-list">
        {users.map(user => (
          <div key={user.id} className="user-card">
            <div className="user-info">
              <User className="user-icon" />
              <div>
                <h4>{user.name}</h4>
                <p>{user.email}</p>
                <small>ID: {user.id}</small>
              </div>
            </div>
            <button 
              className="delete-user-btn"
              onClick={() => onDeleteUser(user.id)}
            >
              <Trash2 size={16} />
            </button>
          </div>
        ))}
      </div>
    </div>
  );
};

const StatsView = ({ stats, shifts }) => {
  return (
    <div className="stats-container">
      <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –º–µ—Å—è—Ü</h2>
      
      <div className="stats-grid">
        <div className="stat-card">
          <Clock className="stat-icon" />
          <div className="stat-info">
            <h3>{stats.total_shifts || 0}</h3>
            <p>–í—Å–µ–≥–æ —Å–º–µ–Ω</p>
          </div>
        </div>
        
        <div className="stat-card">
          <div className="stat-icon">‚òÄÔ∏è</div>
          <div className="stat-info">
            <h3>{stats.day_shifts || 0}</h3>
            <p>–î–Ω–µ–≤–Ω—ã—Ö —Å–º–µ–Ω</p>
          </div>
        </div>
        
        <div className="stat-card">
          <div className="stat-icon">üåô</div>
          <div className="stat-info">
            <h3>{stats.night_shifts || 0}</h3>
            <p>–ù–æ—á–Ω—ã—Ö —Å–º–µ–Ω</p>
          </div>
        </div>
        
        <div className="stat-card">
          <BarChart3 className="stat-icon" />
          <div className="stat-info">
            <h3>{stats.total_hours || 0}</h3>
            <p>–ß–∞—Å–æ–≤ —Ä–∞–±–æ—Ç—ã</p>
          </div>
        </div>
      </div>

      <div className="shifts-list">
        <h3>–ú–æ–∏ —Å–º–µ–Ω—ã</h3>
        {shifts.map((shift, idx) => (
          <div key={idx} className="shift-item">
            <div className="shift-date">{shift.date}</div>
            <div className={`shift-badge shift-${shift.type}`}>
              {shift.type === 'day' ? '‚òÄÔ∏è –î–µ–Ω—å' : shift.type === 'night' ? 'üåô –ù–æ—á—å' : `‚è∞ ${shift.hours}—á`}
            </div>
          </div>
        ))}
      </div>
    </div>
  );
};

export default App;